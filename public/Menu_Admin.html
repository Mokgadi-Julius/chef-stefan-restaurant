<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chef Stefan - Menu Management</title>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css?v=1.0.1" />
    <link rel="stylesheet" href="assets/css/site.css?v=1.0.1" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    
    <link rel="stylesheet" href="assets/css/header.css?v=1.0.1">
  </head>

  <body>
    <button class="btn btn-primary toggle-btn" id="toggleSidebar">
      Toggle Sidebar
    </button>
    <div class="sidebar d-flex flex-column p-3 bg-light" id="sidebar">
      <a href="/" class="d-flex align-items-center mb-3 text-decoration-none">
        <span class="fs-4 admin-title">
          <span class="header-logo">üç≥</span>
          <span class="header-text">Private Chef Stefan</span>
        </span>
      </a>
      
      <hr />
    <ul class="nav nav-pills flex-column mb-auto">
      <li>
        <a href="admin-dashboard.html" class="nav-link">
          <i class="fas fa-tachometer-alt me-2"></i>
          Dashboard
        </a>
      </li>
      <li>
        <a href="Admin.html" class="nav-link">
          <i class="fas fa-users me-2"></i>
          Users
        </a>
      </li>
      <li>
        <a href="admin-menu.html" class="active"><i class="bi bi-book"></i> Menu Management</a>
      </li>
      <li>
        <a href="admin-categories.html" class="nav-link">
          <i class="fas fa-tags me-2"></i>
          Categories
        </a>
      </li>
      <button onclick="logout()" class="btn btn-danger btn-block">
        <i class="fas fa-sign-out-alt me-2"></i>
        Logout
      </button>
      <a href="index.html" class="btn btn-secondary btn-block mt-2">Back to Website</a>
    </ul>
    <hr />
    </div>

    <div id="content" class="content container mt-5">
      <div class="row mb-4">
        <div class="col d-flex justify-content-between align-items-center">
          <h1>Manage Menu</h1>
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMenuItemModal">
            <i class="fas fa-plus me-2"></i>Add Menu Item
          </button>
        </div>
      </div>
      
      <!-- Filter Controls -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <label for="categoryFilter" class="form-label">Filter by Category</label>
              <select class="form-select" id="categoryFilter">
                <option value="">All Categories</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="searchMenu" class="form-label">Search Menu Items</label>
              <input type="text" class="form-control" id="searchMenu" placeholder="Search by name...">
            </div>
            <div class="col-md-4">
              <label for="sortMenu" class="form-label">Sort By</label>
              <select class="form-select" id="sortMenu">
                <option value="name">Name (A-Z)</option>
                <option value="price-low">Price (Low to High)</option>
                <option value="price-high">Price (High to Low)</option>
                <option value="category">Category</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <div class="table-responsive" style="max-height: 75vh;">
        <table class="table table-bordered table-striped table-hover">
          <thead class="sticky-top bg-light">
            <tr>
              <th>Image</th>
              <th>Food Name</th>
              <th>Category</th>
              <th>Price</th>
              <th>Description</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="menuItemsTableBody">
            <!-- Menu items will be loaded dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <nav>
      <ul class="pagination justify-content-center" id="pagination-controls"></ul>
    </nav>

    <!-- Add Menu Item Modal -->
    <div class="modal fade" id="addMenuItemModal" tabindex="-1" aria-labelledby="addMenuItemModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addMenuItemModalLabel">Add New Menu Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="menuItemForm">
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="itemName" class="form-label">Item Name</label>
                    <input type="text" class="form-control" id="itemName" required>
                  </div>
                  <div class="mb-3">
                    <label for="itemPrice" class="form-label">Price (R)</label>
                    <input type="number" class="form-control" id="itemPrice" step="0.01" min="0" required>
                  </div>
                  <div class="mb-3">
                    <label for="itemCategory" class="form-label">Category</label>
                    <select class="form-select" id="itemCategory" required>
                      <option value="">Select Category</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="itemDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="itemDescription" rows="4" required></textarea>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="itemImage" class="form-label">Item Image</label>
                    <input type="file" class="form-control" id="itemImage" accept="image/*">
                    <img id="imagePreview" class="img-fluid mt-2 d-none" style="max-height: 200px;" alt="Preview">
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="itemAvailable" checked>
                      <label class="form-check-label" for="itemAvailable">Available</label>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="itemFeatured">
                      <label class="form-check-label" for="itemFeatured">Featured Item</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Add Menu Item</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Edit Menu Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editForm">
        <div class="modal-body">
          <input type="hidden" id="editItemId" />
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editItemName" class="form-label">Item Name</label>
                <input type="text" class="form-control" id="editItemName" required />
              </div>
              <div class="mb-3">
                <label for="editItemPrice" class="form-label">Price (R)</label>
                <input type="number" class="form-control" id="editItemPrice" step="0.01" min="0" required />
              </div>
              <div class="mb-3">
                <label for="editItemCategory" class="form-label">Category</label>
                <select class="form-select" id="editItemCategory" required>
                  <option value="">Select Category</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="editItemDescription" class="form-label">Description</label>
                <textarea class="form-control" id="editItemDescription" rows="4" required></textarea>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editItemImage" class="form-label">Change Image</label>
                <input type="file" class="form-control" id="editItemImage" accept="image/*">
                <img id="editImagePreview" class="img-fluid mt-2 d-none" style="max-height: 200px;" alt="Preview">
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="editItemAvailable">
                  <label class="form-check-label" for="editItemAvailable">Available</label>
                </div>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="editItemFeatured">
                  <label class="form-check-label" for="editItemFeatured">Featured Item</label>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this menu item?
            <p class="text-danger mt-2"><strong>Warning:</strong> This action cannot be undone.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
          </div>
        </div>
      </div>
    </div>

<script>
  let menuItems = [];
  let categories = [];
  let selectedItemId = null;

  // Initialize menu management
  function initializeMenuManagement() {
    loadCategories();
    loadMenuItems();
    populateCategoryDropdowns();
    setupEventListeners();
  }

  // Load categories from localStorage
  function loadCategories() {
    categories = JSON.parse(localStorage.getItem('categories') || '[]');
    
    // Initialize with default categories if none exist
    if (categories.length === 0) {
      categories = [
        { id: 'appetizers', name: 'Appetizers', color: '#e74c3c' },
        { id: 'mains', name: 'Main Courses', color: '#f39c12' },
        { id: 'desserts', name: 'Desserts', color: '#9b59b6' },
        { id: 'beverages', name: 'Beverages', color: '#3498db' }
      ];
      localStorage.setItem('categories', JSON.stringify(categories));
    }
  }

  // Load menu items from localStorage
  function loadMenuItems() {
    menuItems = JSON.parse(localStorage.getItem('menuItems') || '[]');
    displayMenuItems();
  }

  // Save menu items to localStorage
  function saveMenuItems() {
    localStorage.setItem('menuItems', JSON.stringify(menuItems));
  }

  // Populate category dropdowns
  function populateCategoryDropdowns() {
    const categorySelects = ['itemCategory', 'editItemCategory', 'categoryFilter'];
    
    categorySelects.forEach(selectId => {
      const select = document.getElementById(selectId);
      if (selectId === 'categoryFilter') {
        select.innerHTML = '<option value="">All Categories</option>';
      } else {
        select.innerHTML = '<option value="">Select Category</option>';
      }
      
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        select.appendChild(option);
      });
    });
  }

  // Display menu items in table
  function displayMenuItems(filteredItems = null) {
    const tbody = document.getElementById('menuItemsTableBody');
    tbody.innerHTML = '';

    const itemsToDisplay = filteredItems || menuItems;

    if (itemsToDisplay.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center">No menu items found</td></tr>';
      return;
    }

    itemsToDisplay.forEach(item => {
      const category = categories.find(c => c.id === item.category);
      const categoryName = category ? category.name : 'Uncategorized';

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          ${item.image ? 
            `<img src="${item.image}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">` : 
            '<div class="bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; border-radius: 5px;"><i class="fas fa-image text-muted"></i></div>'
          }
        </td>
        <td>${item.name}</td>
        <td><span class="badge" style="background-color: ${category ? category.color : '#6c757d'}">${categoryName}</span></td>
        <td>R${parseFloat(item.price).toFixed(2)}</td>
        <td>${item.description.length > 50 ? item.description.substring(0, 50) + '...' : item.description}</td>
        <td>
          ${item.available ? '<span class="badge bg-success">Available</span>' : '<span class="badge bg-secondary">Unavailable</span>'}
          ${item.featured ? '<span class="badge bg-warning ms-1">Featured</span>' : ''}
        </td>
        <td>
          <button class="btn btn-warning btn-sm me-1" onclick="editMenuItem('${item.id}')">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-danger btn-sm" onclick="deleteMenuItem('${item.id}')">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  // Setup event listeners
  function setupEventListeners() {
    // Image upload handlers
    document.getElementById('itemImage').addEventListener('change', handleImageUpload);
    document.getElementById('editItemImage').addEventListener('change', handleEditImageUpload);

    // Search and filter handlers
    document.getElementById('searchMenu').addEventListener('input', filterMenuItems);
    document.getElementById('categoryFilter').addEventListener('change', filterMenuItems);
    document.getElementById('sortMenu').addEventListener('change', filterMenuItems);

    // Form submission handlers
    document.getElementById('menuItemForm').addEventListener('submit', addMenuItem);
    document.getElementById('editForm').addEventListener('submit', updateMenuItem);
  }

  // Handle image upload
  function handleImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('imagePreview');
        preview.src = e.target.result;
        preview.classList.remove('d-none');
      };
      reader.readAsDataURL(file);
    }
  }

  // Handle edit image upload
  function handleEditImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('editImagePreview');
        preview.src = e.target.result;
        preview.classList.remove('d-none');
      };
      reader.readAsDataURL(file);
    }
  }

  // Add menu item
  function addMenuItem(event) {
    event.preventDefault();

    const imageFile = document.getElementById('itemImage').files[0];
    let imageData = null;

    if (imageFile) {
      const reader = new FileReader();
      reader.onload = function(e) {
        imageData = e.target.result;
        saveMenuItem(imageData);
      };
      reader.readAsDataURL(imageFile);
    } else {
      saveMenuItem(null);
    }

    function saveMenuItem(image) {
      const newItem = {
        id: Date.now().toString(),
        name: document.getElementById('itemName').value,
        price: parseFloat(document.getElementById('itemPrice').value),
        category: document.getElementById('itemCategory').value,
        description: document.getElementById('itemDescription').value,
        image: image,
        available: document.getElementById('itemAvailable').checked,
        featured: document.getElementById('itemFeatured').checked,
        createdAt: new Date().toISOString()
      };

      menuItems.push(newItem);
      saveMenuItems();
      displayMenuItems();

      // Reset form and close modal
      document.getElementById('menuItemForm').reset();
      document.getElementById('imagePreview').classList.add('d-none');
      bootstrap.Modal.getInstance(document.getElementById('addMenuItemModal')).hide();

      showAlert('Menu item added successfully!', 'success');
    }
  }

  // Edit menu item
  function editMenuItem(itemId) {
    const item = menuItems.find(i => i.id === itemId);
    if (!item) return;

    selectedItemId = itemId;

    document.getElementById('editItemId').value = item.id;
    document.getElementById('editItemName').value = item.name;
    document.getElementById('editItemPrice').value = item.price;
    document.getElementById('editItemCategory').value = item.category;
    document.getElementById('editItemDescription').value = item.description;
    document.getElementById('editItemAvailable').checked = item.available;
    document.getElementById('editItemFeatured').checked = item.featured;

    if (item.image) {
      const preview = document.getElementById('editImagePreview');
      preview.src = item.image;
      preview.classList.remove('d-none');
    }

    new bootstrap.Modal(document.getElementById('editModal')).show();
  }

  // Update menu item
  function updateMenuItem(event) {
    event.preventDefault();

    const itemIndex = menuItems.findIndex(i => i.id === selectedItemId);
    if (itemIndex === -1) return;

    const imageFile = document.getElementById('editItemImage').files[0];

    if (imageFile) {
      const reader = new FileReader();
      reader.onload = function(e) {
        updateItemData(e.target.result);
      };
      reader.readAsDataURL(imageFile);
    } else {
      updateItemData(menuItems[itemIndex].image);
    }

    function updateItemData(image) {
      menuItems[itemIndex] = {
        ...menuItems[itemIndex],
        name: document.getElementById('editItemName').value,
        price: parseFloat(document.getElementById('editItemPrice').value),
        category: document.getElementById('editItemCategory').value,
        description: document.getElementById('editItemDescription').value,
        image: image,
        available: document.getElementById('editItemAvailable').checked,
        featured: document.getElementById('editItemFeatured').checked,
        updatedAt: new Date().toISOString()
      };

      saveMenuItems();
      displayMenuItems();

      bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
      showAlert('Menu item updated successfully!', 'success');
    }
  }

  // Delete menu item
  function deleteMenuItem(itemId) {
    selectedItemId = itemId;
    new bootstrap.Modal(document.getElementById('deleteConfirmationModal')).show();
  }

  // Confirm delete menu item
  document.getElementById('confirmDelete').addEventListener('click', function() {
    const itemIndex = menuItems.findIndex(i => i.id === selectedItemId);
    if (itemIndex === -1) return;

    menuItems.splice(itemIndex, 1);
    saveMenuItems();
    displayMenuItems();

    bootstrap.Modal.getInstance(document.getElementById('deleteConfirmationModal')).hide();
    showAlert('Menu item deleted successfully!', 'success');
  });

  // Filter menu items
  function filterMenuItems() {
    const search = document.getElementById('searchMenu').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryFilter').value;
    const sortBy = document.getElementById('sortMenu').value;

    let filtered = menuItems.filter(item => {
      const matchesSearch = item.name.toLowerCase().includes(search);
      const matchesCategory = !categoryFilter || item.category === categoryFilter;
      
      return matchesSearch && matchesCategory;
    });

    // Sort items
    filtered.sort((a, b) => {
      switch (sortBy) {
        case 'name':
          return a.name.localeCompare(b.name);
        case 'price-low':
          return a.price - b.price;
        case 'price-high':
          return b.price - a.price;
        case 'category':
          return a.category.localeCompare(b.category);
        default:
          return 0;
      }
    });

    displayMenuItems(filtered);
  }

  // Show alert message
  function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.body.appendChild(alertDiv);

    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.parentNode.removeChild(alertDiv);
      }
    }, 3000);
  }

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', initializeMenuManagement);
</script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/bootstrap.bundle.min.js?v=1.0.1"></script>
    <script src="assets/js/auth.js?v=1.0.1"></script>
  </body>
</html>